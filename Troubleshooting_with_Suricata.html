<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" class="no-js">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Troubleshooting Suricata &middot; M
    
  </title>

  
    <meta name="description" content="Troubleshooting Suricata IDS"/>
    <meta name="keywords" content="">
  
  <meta name="author" content="Heiswayi Nrird">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@1_mod_m">
  <meta name="twitter:creator" content="@1_mod_m">
  
    <meta name="twitter:title" content="Troubleshooting Suricata">
    <meta name="twitter:description" content="Troubleshooting Suricata IDS">
  

  <meta property="og:type" content="website"/>
  
    <meta property="og:title" content="Troubleshooting Suricata"/>
    <meta property="og:url" content="http://localhost:4000/Troubleshooting_with_Suricata.html"/>
    <meta property="og:description" content="Troubleshooting Suricata IDS"/>
    <meta property="og:site_name" content="Troubleshooting Suricata"/>
  

  <link rel="apple-touch-icon" sizes="57x57" href="http://localhost:4000/public/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="http://localhost:4000/public/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/public/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="http://localhost:4000/public/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/public/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="http://localhost:4000/public/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/public/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="http://localhost:4000/public/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/public/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="http://localhost:4000/public/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="http://localhost:4000/public/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="http://localhost:4000/public/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="http://localhost:4000/public/icons/favicon-16x16.png">
  <link rel="manifest" href="http://localhost:4000/public/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#f3f3f3">
  <meta name="msapplication-TileImage" content="http://localhost:4000/public/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="google-site-verification" content="aSavCGGU0uSN5HEHnI7ZiMqVKxn7mfUPCGMVJvmDQ1w" />
  <meta name="wot-verification" content="6da2597a332a1fadad8f"/>

  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/atom.xml">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/normalize.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/style.css">

  <script src="http://localhost:4000/public/js/modernizr.custom.js"></script>
  <script src="http://localhost:4000/public/js/jquery-1.11.2.min.js"></script>
  <script src="http://localhost:4000/public/js/masonry.pkgd.min.js"></script>

  <!--[if lt IE 9]>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.1.0/respond.min.js"></script>
    <script src="http://localhost:4000/public/js/rem.min.js"></script>
  <![endif]-->
</head>


  <body>

    <div class="wrap">
      <div class="master-nav">
        <div class="nav">
            <ul class="top-menu">
              <li><a href="/"><i class="fa fa-home"></i> Home</a></li>
              <li><a href="/about.html"><i class="fa fa-info-circle"></i> About</a></li>
              <li><a href="/notes.html"><i class="fa fa-pencil"></i> Posts</a></li>
              <li><a class="resume" href="https://1modm.github.io/documentation/"><i class="fa fa-file-text-o"></i> Notes</a></li>
              <li><a class="special" href="https://github.com/1modm?tab=repositories"><i class="fa fa-github-alt"></i> Repositories</a></li>

            </ul>
        </div>
      </div>

      <div class="masthead">
        <div class="container">
          <h2 class="masthead-title">
            <a href="/" title="Home">M</a>
            <small></small>
          </h2>

          <div class="footer-social-links">
  <a href="https://www.linkedin.com/in/mmorillo" title="LinkedIn" target="_blank"><i class="fa fa-linkedin"></i></a>
  <a href="https://twitter.com/1_mod_m" title="Twitter" target="_blank"><i class="fa fa-twitter"></i></a>
  <a href="https://github.com/1modm" title="GitHub" target="_blank"><i class="fa fa-github-alt"></i></a>
</div>


        </div>
      </div>

      <div class="container content">
        <div class="post">
  <div class="post-top-meta">
    <div class="post-date">January 06, 2017 &middot; <span class="reading-time" title="Estimated Reading Time">
  
  
    4 minutes read
  
</span>
</div>
    <h1 class="post-title">Troubleshooting Suricata</h1>
  </div>

  <div class="hrline"></div>

  <p><a href="https://suricata-ids.org/">Suricata</a> is a free and open source, mature, fast and robust network threat detection engine.</p>

<p>The <strong>Suricata</strong> engine is capable of real time intrusion detection (IDS), inline intrusion prevention (IPS), network security monitoring (NSM) and offline pcap processing.</p>

<h3 id="documentation">Documentation</h3>
<p>Once we have Suricata installed and running the best way to check all the available options is to go to the official doc site: <a href="http://suricata.readthedocs.io/en/latest/">http://suricata.readthedocs.io/en/latest/</a></p>

<h3 id="configuration-files">Configuration files</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/suricata/suricata.yaml
</code></pre></div></div>

<p>Remember to set your <strong>$HOMENET</strong> variable in <strong>/etc/suricata/suricata.yaml</strong>, any traffic out of the value set in this variable will be ignored also make sure you are logging to <strong>/var/log/suricata</strong>, and that the directory exists.</p>

<p><strong>Configuring Suricata to log to disk</strong>:
Configure the <strong>logging outputs</strong> for Suricata, in <strong>suricata.yaml</strong> configuration file, enable “file” logging by changing the value of the “enabled” key values set to “yes” from “no”. The config file should look like the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  # Define your logging outputs.  If none are defined, or they are all
  # disabled you will get the default - console output.
  outputs:
  - console:
      enabled: yes
  - file:
      enabled: yes
      filename: /var/log/suricata/suricata.log
  - syslog:
      enabled: no
      facility: local5
      format: "[%i] &lt;%d&gt; -- "
</code></pre></div></div>

<p><strong>Configuring Suricata to enable DNS and TLS logging</strong>
In <strong>suricata.yaml</strong> configuration file ensure that http-log, tls-log and dns-log have the “enabled” key values set to “yes”. When you have completed this step. The config file should look like the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  - http-log:
      enabled: yes
      filename: http.log
      append: yes
      #extended: yes     # enable this for extended logging information
      #custom: yes       # enabled the custom logging format (defined by customformat)
      #filetype: regular # 'regular', 'unix_stream' or 'unix_dgram'

  # a line based log of TLS handshake parameters (no alerts)
  - tls-log:
      enabled: yes  # Log TLS connections.
      filename: tls.log # File to store TLS logs.
      append: yes
      #filetype: regular # 'regular', 'unix_stream' or 'unix_dgram'
      #extended: yes # Log extended information like fingerprint
      certs-log-dir: certs # directory to store the certificates files

  # a line based log of DNS requests and/or replies (no alerts)
  - dns-log:
      enabled: yes
      filename: dns.log
      append: yes
</code></pre></div></div>

<h3 id="log-files">Log files</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/var/log/suricata/suricata-start.log
/var/log/suricata/suricata.log
/var/log/suricata/stats.log
/var/log/suricata/core/
</code></pre></div></div>

<p>The folder <strong>/var/log/suricata/core/</strong> will contain any core dumps in case of a segfault. 
Further reading on what to do and <a href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Reporting_Bugs">how to report Suricata bugs</a>.</p>

<p>Check drops in stats.log file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tail -f /var/log/suricata/stats.log | grep -i capture.kernel_drops
tail -f /var/log/suricata/stats.log | grep -i drop
</code></pre></div></div>

<h3 id="manual-start">Manual start</h3>

<p>Run the command with the <strong>–init-errors-fatal</strong> option at first to see if there are any issues.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/suricata -c /etc/suricata/suricata.yaml -i eth0 --init-errors-fatal
</code></pre></div></div>

<p><strong>-D</strong> option to run in daemon mode and <strong>–pfring</strong> option. PF_RING is a new type of network socket that dramatically improves the packet capture speed, and is available for Linux kernels 2.6.32 and newer.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/suricata -c /etc/suricata/suricata.yaml --pidfile /var/run/suricata.pid -D --pfring=eth0
</code></pre></div></div>

<p>Manually start in debug mode:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/suricata -c /etc/suricata/suricata.yaml --pidfile /var/run/suricata.pid -D --pfring=eth0 --enable-debug
</code></pre></div></div>

<h3 id="run-in-pcap-offline-mode">Run in pcap offline mode</h3>

<p>Reading files from pcap file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>suricata -r &lt;PCAP&gt;
</code></pre></div></div>

<h3 id="threads-used-by-suricata">Threads used by Suricata</h3>

<p>Using <code class="highlighter-rouge">top</code> to see if the individual af_packet threads</p>

<ol>
  <li>Enter <code class="highlighter-rouge">top -H</code> to view threads in top</li>
  <li>Press <code class="highlighter-rouge">o</code> to add a filter</li>
  <li>Enter <code class="highlighter-rouge">COMMAND=AFPacket</code> then press Enter key</li>
</ol>

<h3 id="testing-suricata">Testing Suricata</h3>

<p>1- Check that you have enable the next rule in /etc/suricata/rules/emerging-user_agents.rules</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>alert http $HOME_NET any -&gt; $EXTERNAL_NET any (msg:"ET USER_AGENTS Suspicious User Agent (BlackSun)"; flow:to_server,established; content:"User-Agent|3a| BlackSun"; nocase; http_header; reference:url,www.bitdefender.com/VIRUS-1000328-en--Trojan.Pws.Wow.NCY.html; reference:url,doc.emergingthreats.net/bin/view/Main/2008983; classtype:trojan-activity; sid:2008983; rev:6;)

</code></pre></div></div>
<p>2- Issue traffic to google.com using the user-agent string “BlackSun”</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># apt-get install curl
# curl -A "BlackSun" www.google.com
</code></pre></div></div>

<p>3- Generate fake malware traffic</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># wget testmyids.com 
</code></pre></div></div>

<p>4- Create a fake scan to generate port scan traffic</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sS &lt;NETWORK INTERNAL HOST IP&gt; -D 118.186.71.134
</code></pre></div></div>

<h3 id="tools">Tools</h3>

<p><a href="https://github.com/jasonish/py-idstools">py-idstools</a>: Snort and Suricata Rule and Event Utilities in Python (Including an easy to use Unified2 File Reader)</p>

<p>Check the documentation for further analysis: <a href="https://idstools.readthedocs.io">https://idstools.readthedocs.io</a></p>

<p>With <a href="https://idstools.readthedocs.io/en/latest/tools/u2json.html">u2json</a> you can read the alerts generated and convert to JSON, for example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>idstools-u2json /var/log/suricata/unified2.alert.1473071280

idstools-u2json --snort-conf /etc/suricata/suricata.yaml --directory /var/log/suricata  --prefix unified2.alert  --follow  --delete --output /tmp/alerts.json 

idstools-u2json --snort-conf /etc/suricata/suricata.yaml --directory /var/log/suricata  --prefix unified2.alert  --follow  --output /tmp/alerts.json 
</code></pre></div></div>

<p>The next example will read the <strong>unified2.alert</strong> files generated by Suricata and will print the output of every alert/event:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: UTF-8 -*-</span>
<span class="kn">from</span> <span class="nn">idstools</span> <span class="kn">import</span> <span class="n">unified2</span>

<span class="c"># Event Reader</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">unified2</span><span class="o">.</span><span class="n">SpoolEventReader</span><span class="p">(</span><span class="s">"/var/log/suricata"</span><span class="p">,</span> <span class="s">"unified2.alert"</span><span class="p">,</span> <span class="n">follow</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c"># Output</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></div>

  
</div>
<div class="back"><a href="/notes.html"><i class="fa fa-chevron-left"></i> Back</a></div>

      </div>
    </div>

	  <div class="footer">
	<div class="hrline"></div>

	<div class="copyright">Made with <span style="color:#e00"><i class="fa fa-heart"></i></span> using <a href="http://jekyllrb.com">Jekyll</a> &middot; <i class="fa fa-code"></i> on <a href="https://github.com/heiswayi/heiswayi.github.io_jekyll_source">GitHub</a> <i class="fa fa-github-alt"></i><br>&copy; 2017 </div>
</div>

<script>
$(window).load(function() {
	$('.grid').masonry({
		itemSelector: '.grid-item',
		columnWidth: '.grid-sizer',
		gutter: 10
	});
});
</script>


	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-xxxx', 'auto');
  ga('send', 'pageview');
</script>




  </body>
</html>
