<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" class="no-js">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      BACnet CVE-2023-51773 &middot; M
    
  </title>

  
    <meta name="description" content="CVE-2023-51773 BACnet Protocol Stack Segmentation fault leading to denial of service"/>
    <meta name="keywords" content="CVE-2023-51773 BACnet">
  
  <meta name="author" content="Miguel Morillo">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@1_mod_m">
  <meta name="twitter:creator" content="@1_mod_m">
  
    <meta name="twitter:title" content="BACnet CVE-2023-51773">
    <meta name="twitter:description" content="CVE-2023-51773 BACnet Protocol Stack Segmentation fault leading to denial of service">
  

  <meta property="og:type" content="website"/>
  
    <meta property="og:title" content="BACnet CVE-2023-51773"/>
    <meta property="og:url" content="https://1modm.github.io/CVE-2023-51773.html"/>
    <meta property="og:description" content="CVE-2023-51773 BACnet Protocol Stack Segmentation fault leading to denial of service"/>
    <meta property="og:site_name" content="BACnet CVE-2023-51773"/>
  

  <link rel="apple-touch-icon" sizes="57x57" href="https://1modm.github.io/public/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://1modm.github.io/public/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://1modm.github.io/public/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://1modm.github.io/public/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://1modm.github.io/public/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://1modm.github.io/public/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://1modm.github.io/public/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://1modm.github.io/public/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://1modm.github.io/public/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="https://1modm.github.io/public/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://1modm.github.io/public/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://1modm.github.io/public/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://1modm.github.io/public/icons/favicon-16x16.png">
  <link rel="manifest" href="https://1modm.github.io/public/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#f3f3f3">
  <meta name="msapplication-TileImage" content="https://1modm.github.io/public/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="google-site-verification" content="aSavCGGU0uSN5HEHnI7ZiMqVKxn7mfUPCGMVJvmDQ1w" />
  <meta name="wot-verification" content="6da2597a332a1fadad8f"/>

  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://1modm.github.io/atom.xml">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://1modm.github.io/public/css/normalize.css">
  <link rel="stylesheet" href="https://1modm.github.io/public/css/style.css">

  <script src="https://1modm.github.io/public/js/modernizr.custom.js"></script>
  <script src="https://1modm.github.io/public/js/jquery-1.11.2.min.js"></script>
  <script src="https://1modm.github.io/public/js/masonry.pkgd.min.js"></script>

  <!--[if lt IE 9]>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.1.0/respond.min.js"></script>
    <script src="https://1modm.github.io/public/js/rem.min.js"></script>
  <![endif]-->
</head>


  <body>

    <div class="wrap">
      <div class="master-nav">
        <div class="nav">
            <ul class="top-menu">
              <li><a href="/"><i class="fa fa-home"></i> Home</a></li>
              <li><a href="/about.html"><i class="fa fa-info-circle"></i> About</a></li>
              <li><a href="/notes.html"><i class="fa fa-pencil"></i> Posts</a></li>
              <li><a class="resume" href="https://1modm.github.io/documentation/"><i class="fa fa-file-text-o"></i> Notes</a></li>
              <li><a class="special" href="https://github.com/1modm?tab=repositories"><i class="fa fa-github-alt"></i> Repositories</a></li>

            </ul>
        </div>
      </div>

      <div class="masthead">
        <div class="container">
          <h2 class="masthead-title">
            <a href="/" title="Home">M</a>
            <small></small>
          </h2>

          <div class="footer-social-links">
  <a href="https://www.linkedin.com/in/mmorillo" title="LinkedIn" target="_blank"><i class="fa fa-linkedin"></i></a>
  <a href="https://twitter.com/1_mod_m" title="Twitter" target="_blank"><i class="fa fa-twitter"></i></a>
  <a href="https://github.com/1modm" title="GitHub" target="_blank"><i class="fa fa-github-alt"></i></a>
</div>


        </div>
      </div>

      <div class="container content">
        <div class="post">
  <div class="post-top-meta">
    <div class="post-date">December 25, 2023 &middot; <span class="reading-time" title="Estimated Reading Time">
  
  
    5 minutes read
  
</span>
</div>
    <h1 class="post-title">BACnet CVE-2023-51773</h1>
  </div>

  <div class="hrline"></div>

  <p>Is there an increase of interest and focus in Cybersecurity referring to Industrial Control Systems (ICSs), not only PLCs, HMIs, RTUs and sensors, there are other elements like chillers, industrial refrigeration, fire detection, fire suppression, energy storage, HVACs, etc. which can be managed through the BACnet protocol.</p>

<p>Usually are referenced under the term “Intelligent Buildings”, however, their use is neither exclusive to them nor is it something relatively new. The building management is given by the acronym BMS, Building Management System and must be distinguished between residential buildings or industrial buildings. In general, BMS systems integrate a set of subsystems in charge of lighting, fire, alarm, elevator, ventilation, temperature, etc. control systems. Although many of them are common to both environments we cannot say that they are similar since the applications and scope are different.</p>

<p>These systems must communicate with each other for their own operation and management. One of the protocols used is BACnet (Buiding Automation Control Network) a Data Communication Protocol for Building Automation and Control Networks approved by the ASHRAE Standards Committee. In June 1987 the American Society of Heating, Refrigeration and Air-conditioning Engineers (ASHRAE) set up the Standard Project Committee 135 (SPC 135) to develop a data communications protocol for Building, Automation and Control Networks (BACnet). As well as becoming a US national standard in 1995 (ASHRAE/ANSI 135-1995) and then updated in 2001, in many countries it also became an ISO standard 16484-5 in January 2003. BACnet also became a European standard CEN TC 247 in 2003.</p>

<p>BACnet has  been  designed  specifically  to  meet  the  communication  needs  of  building  automation  and  control  systems  for  applications  such  as  heating,  ventilating,  and  air-conditioning control, lighting control, access control, and fire detection systems. The BACnet protocol provides mechanisms by which computerized equipment of arbitrary function may exchange information, regardless of the particular building service it performs. As a result, the BACnet protocol may be used by head-end computers, general-purpose direct digital controllers, and application specific or unitary controllers with equal effect.</p>

<p>Like many others, each BACNet device is a combination of hardware and software, like devices working as controllers, gateways or user interfaces. Each of them has a unique identifier or instance number that identifies and differentiates them from those existing in the network apart from others with information regarding the inputs and outputs that these devices monitors and controls.</p>

<p>In BACnet we can find 3 differentiated concepts, Objects, Properties and Services, all the information contained within a BACnet device is ordered as objects, which makes it a protocol oriented precisely to this, to objects. Each “Object” represents a component of the device itself or a set of information that can be requested by another through other protocols or layers such as Ethernet, IP, RS-485, etc. The protocol defines more than 50 types of objects for the most common uses.</p>

<h2 id="bacnet">BACnet</h2>

<p>BACnet was designed to allow communication of building automation and control systems for applications such as heating, ventilating, and air-conditioning control (HVAC), lighting control, access control, and fire detection systems and their associated equipment. The BACnet protocol provides mechanisms for computerized building automation devices to exchange information, regardless of the particular building service they perform.</p>

<p>BACnet is a communications protocol for Building Automation and Control (BAC) networks UDP based and contains 3 main headers the BVLC, NPDU and APDU.</p>

<p>A request to BACnet passes down through the lower layers of the protocol stack in the local device, this process can be observed in the next image <a href="http://bdocam.com/I2BS_TEST/I2BS/BacNet/Protocol/135_2004.pdf">Source</a>.</p>

<p><img src="public/images/BACnet_protocol_stack_data_flow.png" alt="BACnet_protocol_stack_data_flow" title="BACnet_protocol_stack_data_flow" /></p>

<p>The 3 headers can be examined in the <a href="http://www.bacnetwiki.com/wiki/index.php?title=Main_Page">BACnet Wiki</a></p>

<p><img src="public/images/BACnet_packet.png" alt="BACnet_packet" title="BACnet_packet" /></p>

<h3 id="bvlc-bacnet-virtual-link-control-4-bytes">BVLC (BACNet virtual link control): 4 bytes</h3>

<p>The firts byte defines the type, in this case bacnet/ip 0x81, the second one defines the function 0x0a, and the last 2 bytes defines the length of the whole packet <a href="http://www.bacnetwiki.com/wiki/index.php?title=BACnet_Virtual_Link_Layer">BACnet Wiki</a>:</p>

<ul>
  <li>The firts byte defines the type: bacnet/ip 0x81</li>
  <li>The second byte defines the function 0x0a (ORIGINAL_UNICAST_NPDU = 10)</li>
  <li>The last 2 bytes defines the length of the whole packet</li>
</ul>

<p><img src="public/images/bvlc.png" alt="bvlc" title="bvlc" /></p>

<ul>
  <li>NPDU Function:</li>
</ul>

<p><img src="public/images/bvlc-function.png" alt="bvlc" title="bvlc" /></p>

<p>As we can see in the BACnet packet the UDP Port number used by BACnet communications over IP is 47808:</p>

<p><img src="public/images/bvlc-pcap.png" alt="bvlc" title="bvlc" /></p>

<h3 id="npdu-network-layer-protocol-data-unit-2-bytes">NPDU (Network layer protocol data unit): 2 bytes</h3>

<p>The NPDU consists of a NPCI followed by a NSDU. <a href="http://www.bacnetwiki.com/wiki/index.php?title=Network_Layer_Protocol_Data_Unit">BACnet Wiki</a></p>

<p>According bacnetwiki this is the representation, but be careful here, in practice the headers is just 2 bytes, Version (Always 0x01) and NPCI Control Octet:</p>

<p><img src="public/images/npdu.png" alt="npdu" title="npdu" /></p>

<p>NPDU Layer:</p>

<p><img src="public/images/npdu-pcap.png" alt="npdu" title="npdu" /></p>

<h3 id="apdu-network-layer-protocol-data-unit-2-bytes">APDU (Network layer protocol data unit): 2 bytes</h3>

<p>BACnet APDUs carry the Application Layer parameters. The maximum size of an APDU is specified by a device’s Max_APDU_Length_Accepted, be careful with that, otherwise you will face malformed packet issues. <a href="http://www.bacnetwiki.com/wiki/index.php?title=APDU">BACnet APDU</a></p>

<p><img src="public/images/apdu-pcap.png" alt="apdu" title="apdu" /></p>

<h2 id="testbed">Testbed</h2>

<p>If we want to create our own lab and scenario we can install the OpenSource BACnet Protocol Stack and test the connectivity to BACnet port, we need:</p>

<ul>
  <li><a href="https://www.bac-test.com/how-to-build-a-foss-bacnet-server-based-on-steve-kargs-sourceforge-project/">The Free or Open Source Software BACnet Stack</a></li>
  <li>A BACNet port open UDP 47808</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo apt-get install -y build-essential
$ sudo apt-get install subversion
$ svn checkout svn://svn.code.sf.net/p/bacnet/code/trunk/bacnet-stack bacnetServer
$ cd bacnetServer
$ make clean all
$ demo/server/bacserv
</code></pre></div></div>

<h1 id="cve-2023-51773-bacnet-stack-before-132-has-a-decode-function-apdu-buffer-over-read-in-bacapp_decode_application_data-in-bacappc">CVE-2023-51773: BACnet Stack before 1.3.2 has a decode function APDU buffer over-read in bacapp_decode_application_data in bacapp.c.</h1>

<h2 id="disclosure-timeline">Disclosure Timeline</h2>

<ul>
  <li>20/10/2023 Discovered vulnerability and developed baseline proof-of-concept.</li>
  <li>20/12/2023 Reported to https://sourceforge.net/p/bacnet/bugs/85/</li>
  <li>22/12/2023 Asked for a CVE and coordinated disclosure.</li>
  <li>25/12/2023 Mitre response and CVE assigned: CVE-2023-51773</li>
</ul>

<h2 id="cve">CVE</h2>

<p><a href="https://nvd.nist.gov/vuln/detail/CVE-2023-51773">NVD CVE-2023-51773 Details</a></p>

<h2 id="bug-references-and-exploit">Bug References and Exploit</h2>

<ul>
  <li><a href="https://sourceforge.net/p/bacnet/bugs/85/">https://sourceforge.net/p/bacnet/bugs/85/</a></li>
</ul>

<h2 id="fixes">Fixes</h2>

<ul>
  <li><a href="https://github.com/bacnet-stack/bacnet-stack/pull/546">bacnet-stack/pull/546</a></li>
  <li><a href="https://github.com/bacnet-stack/bacnet-stack/pull/546/commits/c465412a076ca6c9ddf649612f2b4e1874d8dcb8">bacnet-stack/pull/546 details</a></li>
  <li><a href="https://github.com/bacnet-stack/bacnet-stack/blob/master/CHANGELOG.md">CHANGELOG</a></li>
  <li><a href="https://github.com/bacnet-stack/bacnet-stack/compare/bacnet-stack-1.3.1...bacnet-stack-1.3.2">bacnet-stack-1.3.2</a></li>
</ul>

  
</div>
<div class="back"><a href="/notes.html"><i class="fa fa-chevron-left"></i> Back</a></div>

      </div>
    </div>

	  <div class="footer">
	<div class="hrline"></div>

	<div class="copyright">Made with <span style="color:#e00"><i class="fa fa-heart"></i></span> using <a href="http://jekyllrb.com">Jekyll</a> &middot; <i class="fa fa-code"></i> on <a href="https://github.com/heiswayi/heiswayi.github.io_jekyll_source">GitHub</a> <i class="fa fa-github-alt"></i><br>&copy; 2024 </div>
</div>

<script>
$(window).load(function() {
	$('.grid').masonry({
		itemSelector: '.grid-item',
		columnWidth: '.grid-sizer',
		gutter: 10
	});
});
</script>


	

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-163650828-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-163650828-1');
</script>




  </body>
</html>
