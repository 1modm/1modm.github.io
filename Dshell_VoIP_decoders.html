<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" class="no-js">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      SIP and RTP decoders for Dshell &middot; M
    
  </title>

  
    <meta name="description" content="Custom Dshell SIP and RTP decoders"/>
    <meta name="keywords" content="">
  
  <meta name="author" content="Heiswayi Nrird">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@1_mod_m">
  <meta name="twitter:creator" content="@1_mod_m">
  
    <meta name="twitter:title" content="SIP and RTP decoders for Dshell">
    <meta name="twitter:description" content="Custom Dshell SIP and RTP decoders">
  

  <meta property="og:type" content="website"/>
  
    <meta property="og:title" content="SIP and RTP decoders for Dshell"/>
    <meta property="og:url" content="/Dshell_VoIP_decoders.html"/>
    <meta property="og:description" content="Custom Dshell SIP and RTP decoders"/>
    <meta property="og:site_name" content="SIP and RTP decoders for Dshell"/>
  

  <link rel="apple-touch-icon" sizes="57x57" href="/public/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/public/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/public/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/public/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/public/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/public/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/public/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/public/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/public/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/public/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/public/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/public/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/public/icons/favicon-16x16.png">
  <link rel="manifest" href="/public/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#f3f3f3">
  <meta name="msapplication-TileImage" content="/public/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <meta name="google-site-verification" content="aSavCGGU0uSN5HEHnI7ZiMqVKxn7mfUPCGMVJvmDQ1w" />
  <meta name="wot-verification" content="6da2597a332a1fadad8f"/>

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/public/css/normalize.css">
  <link rel="stylesheet" href="/public/css/style.css">

  <script src="/public/js/modernizr.custom.js"></script>
  <script src="/public/js/jquery-1.11.2.min.js"></script>
  <script src="/public/js/masonry.pkgd.min.js"></script>

  <!--[if lt IE 9]>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.1.0/respond.min.js"></script>
    <script src="/public/js/rem.min.js"></script>
  <![endif]-->
</head>


  <body>

    <div class="wrap">
      <div class="master-nav">
        <div class="nav">
            <ul class="top-menu">
              <li><a href="/"><i class="fa fa-home"></i> Home</a></li>
              <li><a href="/about.html"><i class="fa fa-info-circle"></i> About</a></li>
              <li><a href="/notes.html"><i class="fa fa-pencil"></i> Posts</a></li>
              <li><a class="resume" href="https://1modm.github.io/documentation/"><i class="fa fa-file-text-o"></i> Notes</a></li>
              <li><a class="special" href="https://github.com/1modm?tab=repositories"><i class="fa fa-github-alt"></i> Repositories</a></li>

            </ul>
        </div>
      </div>

      <div class="masthead">
        <div class="container">
          <h2 class="masthead-title">
            <a href="/" title="Home">M</a>
            <small></small>
          </h2>

          <div class="footer-social-links">
  <a href="https://www.linkedin.com/in/mmorillo" title="LinkedIn" target="_blank"><i class="fa fa-linkedin"></i></a>
  <a href="https://twitter.com/1_mod_m" title="Twitter" target="_blank"><i class="fa fa-twitter"></i></a>
  <a href="https://github.com/1modm" title="GitHub" target="_blank"><i class="fa fa-github-alt"></i></a>
</div>


        </div>
      </div>

      <div class="container content">
        <div class="post">
  <div class="post-top-meta">
    <div class="post-date">October 17, 2016 &middot; <span class="reading-time" title="Estimated Reading Time">
  
  
    5 minutes read
  
</span>
</div>
    <h1 class="post-title">SIP and RTP decoders for Dshell</h1>
  </div>

  <div class="hrline"></div>

  <p><a href="https://github.com/USArmyResearchLab/Dshell">Dshell</a> is an extensible network forensic analysis framework and enables rapid development of plugins to support the dissection of network packet captures.</p>

<p>While I was testing some VoIP packets, I discover that doesnâ€™t exist VoIP specific decoders, so I created the first one to detect SIP Request and Response packets, and a second decoder to extract all the information for RTP packets used in a VoIP communication.</p>

<h3 id="screenshot">Screenshot</h3>

<p><img src="http://i.imgur.com/j0bfx1v.png" alt="Screenshot" /></p>

<h3 id="sip-decoder">SIP decoder</h3>

<p>SIP <a href="https://www.ietf.org/rfc/rfc3261.txt">RFC 3261</a> indicate that SIP is a text-based protocol with syntax similar to that of HTTP. There are two different types of SIP messages:</p>

<ul>
  <li>Requests initiate a SIP transaction between two SIP entities for establishing, controlling, and terminating sessions.</li>
  <li>Responses are send by the user agent server indicating the result of a received request.</li>
</ul>

<p>A SIP session setup example can be similar to this one:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>       Alice's  . . . . . . . . . . . . . . . . . . . .  Bob's
      softphone                                        SIP Phone
         |                |                |                |
         |    INVITE F1   |                |                |
         |---------------&gt;|    INVITE F2   |                |
         |  100 Trying F3 |---------------&gt;|    INVITE F4   |
         |&lt;---------------|  100 Trying F5 |---------------&gt;|
         |                |&lt;-------------- | 180 Ringing F6 |
         |                | 180 Ringing F7 |&lt;---------------|
         | 180 Ringing F8 |&lt;---------------|     200 OK F9  |
         |&lt;---------------|    200 OK F10  |&lt;---------------|
         |    200 OK F11  |&lt;---------------|                |
         |&lt;---------------|                |                |
         |                       ACK F12                    |
         |-------------------------------------------------&gt;|
         |                   Media Session                  |
         |&lt;================================================&gt;|
         |                       BYE F13                    |
         |&lt;-------------------------------------------------|
         |                     200 OK F14                   |
         |-------------------------------------------------&gt;|
         |                                                  |
</code></pre>
</div>

<p>The Session Initiation Protocol (SIP) decoder will extract the Call ID, User agent, Codec, Method, SIP call, Host, and Client MAC address from every SIP request or response packet found in the given pcap. For example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Dshell&gt; decode -d sip &lt;pcap&gt; 

&lt;-- SIP Request --&gt; 
Timestamp: 2016-09-21 22:44:28.220185 UTC - Protocol: UDP - Size: 435 bytes
Sequence and Method: 1 ACK
From: 10.5.1.8:5060 (00:20:80:a1:13:db) to 10.5.1.7:5060 (15:2a:01:b4:0f:47)
Via: SIP/2.0/UDP 10.5.1.8:5060;branch=z9hG4bK940bdac4-8a13-1410-9e58-08002772a6e9;rport
SIP call: "M" &lt;sip:M@10.5.1.8&gt;;tag=0ba2d5c4-8a13-1910-9d56-08002772a6e9  --&gt;  "miguel" &lt;sip:demo-alice@10.5.1.7&gt;;tag=84538c9d-ba7e-e611-937f-68a3c4f0d6ce
Call ID: 0ba2d5c4-8a13-1910-9d57-08002772a6e9@M-PC

--&gt; SIP Response &lt;-- 
Timestamp: 2016-09-21 22:44:27.849761 UTC - Protocol: UDP - Size: 919 bytes
Sequence and Method: 1 INVITE
From: 10.5.1.7:5060 (02:0a:40:12:30:23) to 10.5.1.8:5060 (d5:02:03:94:31:1b)
Via: SIP/2.0/UDP 10.5.1.8:5060;branch=z9hG4bK26a8d5c4-8a13-1910-9d58-08002772a6e9;rport=5060;received=10.5.1.8
SIP call: "M" &lt;sip:M@10.5.1.8&gt;;tag=0ba2d5c4-8a13-1910-9d56-08002772a6e9  --&gt;  "miguel" &lt;sip:demo-alice@10.5.1.7&gt;;tag=84538c9d-ba7e-e611-937f-68a3c4f0d6ce
Call ID: 0ba2d5c4-8a13-1910-9d57-08002772a6e9@M-PC
Codec selected: PCMU 
Rate selected: 8000 

</code></pre>
</div>

<p>To obtain and show a detailed output we can use the <code class="highlighter-rouge">--sip_showpkt</code> option:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Dshell&gt; decode -d sip --sip_showpkt &lt;pcap&gt; 

--&gt; SIP Response &lt;-- 
Timestamp: 2016-09-21 22:44:25.360974 UTC - Protocol: UDP - Size: 349 bytes
From: 10.5.1.7:5060 (15:2a:01:b4:0f:47) to 10.5.1.8:5060 (00:20:80:a1:13:db) 
SIP/2.0 100 Trying
content-length: 0
via: SIP/2.0/UDP 10.5.1.8:5060;branch=z9hG4bK26a8d5c4-8a13-1910-9d58-08002772a6e9;rport=5060;received=10.5.1.8
from: "M" &lt;sip:M@10.5.1.8&gt;;tag=0ba2d5c4-8a13-1910-9d56-08002772a6e9
to: &lt;sip:demo-alice@10.5.1.7&gt;
cseq: 1 INVITE
call-id: 0ba2d5c4-8a13-1910-9d57-08002772a6e9@M-PC

--&gt; SIP Response &lt;-- 
Timestamp: 2016-09-21 22:44:25.387780 UTC - Protocol: UDP - Size: 585 bytes
From: 10.5.1.7:5060 (15:2a:01:b4:0f:47) to 10.5.1.8:5060 (00:20:80:a1:13:db)
SIP/2.0 180 Ringing
content-length: 0
via: SIP/2.0/UDP 10.5.1.8:5060;branch=z9hG4bK26a8d5c4-8a13-1910-9d58-08002772a6e9;rport=5060;received=10.5.1.8
from: "M" &lt;sip:M@10.5.1.8&gt;;tag=0ba2d5c4-8a13-1910-9d56-08002772a6e9
require: 100rel
rseq: 694867676
user-agent: Ekiga/4.0.1
to: "miguel" &lt;sip:demo-alice@10.5.1.7&gt;;tag=84538c9d-ba7e-e611-937f-68a3c4f0d6ce
contact: "miguel" &lt;sip:miguel@10.5.1.7&gt;
cseq: 1 INVITE
allow: INVITE,ACK,OPTIONS,BYE,CANCEL,SUBSCRIBE,NOTIFY,REFER,MESSAGE,INFO,PING,PRACK
call-id: 0ba2d5c4-8a13-1910-9d57-08002772a6e9@M-PC
</code></pre>
</div>

<p>If your packets Ethernet is being replaced by Linux Cooked Capture we can use the next options:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Dshell&gt; decode -d sip --no-vlan --layer2=sll.SLL &lt;pcap&gt; 
</code></pre>
</div>

<p>And to obtain statistics about your SIP packets we can use tshark:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># tshark -q -r &lt;pcap&gt; -Y sip -z sip,stat

===================================================================
SIP Statistics

Number of SIP messages: 28
Number of resent SIP messages: 8

* SIP Status Codes in reply packets
  SIP 180 Ringing         :     1 Packets
  SIP 200 OK              :     5 Packets
  SIP 100 Trying          :     1 Packets

* List of SIP Request methods
  INVITE          :     4 Packets
  PRACK           :     1 Packets
  INFO            :     2 Packets
  ACK             :     1 Packets
  PUBLISH         :    10 Packets
  CANCEL          :     2 Packets
  BYE             :     1 Packets

* Average setup time 2447 ms
 Min 2447 ms
 Max 2447 ms
===================================================================
</code></pre>
</div>

<h3 id="rtp-decoder">RTP decoder</h3>

<p>RTP <a href="https://www.ietf.org/rfc/rfc3550.txt">RFC 3550</a> provides end-to-end network transport functions suitable for applications transmitting real-time data, such as audio, video or simulation data, over multicast or unicast network services.</p>

<p>The RTP Payload is defined in the next RFCs and links:</p>

<ul>
  <li><a href="https://tools.ietf.org/html/rfc2198">RFC 2198</a></li>
  <li><a href="https://tools.ietf.org/html/rfc4855">RFC 4855</a></li>
  <li><a href="https://www.iana.org/assignments/rtp-parameters/rtp-parameters.xhtml">RTP Parameters</a></li>
</ul>

<p>The real-time transport protocol (RTP) decoder will extract the Hosts, Payload Type, Synchronization source, 
Sequence Number, Padding, Marker and Client MAC address from every RTP packet found in the given pcap. For example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Dshell&gt; decode -d rtp &lt;pcap&gt; 

    rtp 2002-07-26 07:19:10        10.1.6.18:2006  --       10.1.3.143:5000  ** 
        From: 10.1.6.18 (00:08:21:91:64:60) to 10.1.3.143 (00:04:76:22:20:17) 
        Payload Type (7 bits): PCMA - Audio - 8000 Hz - 1 Channel
        Sequence Number (16 bits): 9825
        Timestamp (32 bits): 54240 
        Synchronization source (32 bits): 4090175489
        Arrival Time: 1027664350.17
        Contributing source (32 bits): 0, Padding (1 bit): 0, Extension (1 bit): 0, Marker (1 bit): 0
    **
    rtp 2002-07-26 07:19:10       10.1.3.143:5000  --        10.1.6.18:2006  ** 
        From: 10.1.3.143 (00:04:76:22:20:17) to 10.1.6.18 (00:d0:50:10:01:66) 
        Payload Type (7 bits): PCMA - Audio - 8000 Hz - 1 Channel
        Sequence Number (16 bits): 59364
        Timestamp (32 bits): 55680 
        Synchronization source (32 bits): 3739283087
        Arrival Time: 1027664350.2
        Contributing source (32 bits): 0, Padding (1 bit): 0, Extension (1 bit): 0, Marker (1 bit): 0
    **

</code></pre>
</div>

<p>Some data, to compare, obtained with tshark:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># tshark -q -r &lt;pcap&gt; -Y rtp -z rtp,streams
========================= RTP Streams ========================
Src IP addr  Port    Dest IP addr  Port       SSRC          Payload  Pkts         Lost   Max Delta(ms)  Max Jitter(ms) Mean Jitter(ms) Problems?
 10.1.3.143  5000       10.1.6.18  2006 0xDEE0EE8F ITU-T G.711 PCMA   236     0 (0.0%)           34.83            0.83            0.37 
 10.1.6.18  2006      10.1.3.143  5000 0xF3CB2001 ITU-T G.711 PCMA   229     1 (0.4%)           86.12            7.34            2.84 X

</code></pre>
</div>

  
</div>
<div class="back"><a href="/notes.html"><i class="fa fa-chevron-left"></i> Back</a></div>

      </div>
    </div>

	  <div class="footer">
	<div class="hrline"></div>

	<div class="copyright">Made with <span style="color:#e00"><i class="fa fa-heart"></i></span> using <a href="http://jekyllrb.com">Jekyll</a> &middot; <i class="fa fa-code"></i> on <a href="https://github.com/heiswayi/heiswayi.github.io_jekyll_source">GitHub</a> <i class="fa fa-github-alt"></i><br>&copy; 2016 </div>
</div>

<script>
$(window).load(function() {
	$('.grid').masonry({
		itemSelector: '.grid-item',
		columnWidth: '.grid-sizer',
		gutter: 10
	});
});
</script>


	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-xxxx', 'auto');
  ga('send', 'pageview');
</script>




  </body>
</html>
